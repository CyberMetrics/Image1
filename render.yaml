services:
  # 1. Embed Service (Base Layer)
  - type: web
    name: radar-embed
    env: python
    rootDir: services/embed
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn app:app -w 1 -b 0.0.0.0:$PORT --timeout 120
    plan: free
    envVars:
      - key: PORT
        value: 10000

  # 2. Machine Learning Service (Middle Layer)
  - type: web
    name: radar-ml
    env: python
    rootDir: services/ml
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn app:app -w 1 -b 0.0.0.0:$PORT --timeout 120
    plan: free
    envVars:
      - key: MALLOC_ARENA_MAX
        value: 2
      - key: PORT
        value: 10000

  # 3. Web UI Service (Frontend)
  - type: web
    name: radar-web
    env: python
    rootDir: services/web
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn app:app -w 1 -b 0.0.0.0:$PORT --timeout 120
    plan: free
    envVars:
      - key: ML_SERVICE_URL
        fromService:
          type: web
          name: radar-ml
          property: hostport
      - key: MONGO_URI
        sync: false # User will input this in dashboard for security

  # 4. Embedding Service (New)
  - type: web
    name: radar-embed-new
    env: python
    rootDir: services/embed
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn app:app -w 1 -b 0.0.0.0:$PORT --timeout 120
    plan: free
    envVars:
      - key: PORT
        value: 10000
      - key: SECRET_KEY
        generateValue: true
