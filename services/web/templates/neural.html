<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>R.A.D.A.R | NEURAL ENGINE</title>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Montserrat:wght@500;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        /* --- THEME --- */
        :root {
            --bg-core: #050505;
            --bg-panel: rgba(12, 12, 12, 0.95); 
            --border-panel: rgba(255, 255, 255, 0.15);
            --text-main: #F5F5F5;
            --text-dim: #888;
            --c-safe: #CCFF00; --c-info: #00E5FF; --c-warn: #FFD600; --c-crit: #FF0055; --c-purp: #7000FF;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg-core); font-family: 'JetBrains Mono'; color: var(--text-main); overflow: hidden; }
        
        #star-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .bg-grid { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 40px 40px; }

        #app-layout { display: grid; grid-template-columns: 300px 1fr 350px; grid-template-rows: 70px 1fr; height: 100vh; width: 100vw; position: relative; z-index: 10; }

        header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; background: rgba(5,5,5,0.9); border-bottom: 1px solid var(--border-panel); z-index: 20; }
        .brand { font-family: 'Montserrat'; font-weight: 900; font-size: 1.2rem; letter-spacing: -1px; color: white; text-decoration: none; }
        .brand span { color: var(--c-purp); } 
        .mode-badge { border: 1px solid var(--c-purp); color: var(--c-purp); padding: 6px 16px; font-size: 0.75rem; font-weight: 700; border-radius: 4px; letter-spacing: 1px; }

        .sidebar-left { grid-column: 1; border-right: 1px solid var(--border-panel); background: var(--bg-panel); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; gap: 30px; }
        .main-stage { grid-column: 2; position: relative; background: rgba(0,0,0,0.5); overflow: hidden; }
        .sidebar-right { grid-column: 3; border-left: 1px solid var(--border-panel); background: var(--bg-panel); display: flex; flex-direction: column; padding: 20px; gap: 30px; }

        h3 { font-family: 'Montserrat'; font-weight: 800; font-size: 0.8rem; color: var(--text-dim); margin: 0 0 15px 0; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 10px; }

        .vital-card { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .vital-chart { width: 60px; height: 60px; position: relative; }
        .vital-info { flex: 1; }
        .vital-label { font-size: 0.7rem; color: #888; }
        .vital-val { font-size: 1.2rem; font-weight: 700; color: white; }
        
        #three-container { width: 100%; height: 100%; cursor: crosshair; }
        .neural-overlay { position: absolute; bottom: 20px; left: 20px; pointer-events: none; z-index: 20; }
        .neural-stat { font-size: 1.2rem; font-weight: 700; color: var(--c-purp); font-family: 'Montserrat'; }

        .tuner-box { background: #000; padding: 20px; border: 1px solid #333; border-radius: 4px; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; margin: 20px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 10px; background: var(--c-purp); cursor: pointer; margin-top: -8px; border: 1px solid white; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #333; }
        .val-display { font-size: 2rem; color: var(--c-purp); text-align: center; font-weight: 700; margin-bottom: 10px; font-family: 'Montserrat'; }
        .chart-wrapper { height: 150px; width: 100%; margin-top: 20px; }
        .success-msg { color: var(--c-safe); font-size: 0.7rem; text-align: center; margin-top: 10px; display: none; }
        
        /* Toggles */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 4px; }
        .toggle-label { font-size: 0.8rem; font-weight: 700; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 2px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 2px; }
        input:checked + .slider { background-color: var(--c-info); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

<canvas id="star-canvas"></canvas>
<div class="bg-grid"></div>

<div id="app-layout">
    <header>
        <div class="brand">
            <a href="/dashboard" style="color:inherit; text-decoration:none; margin-right:20px;">&lt; DASHBOARD</a>
            R.A.D.A.R <span>//</span> NEURAL ENGINE
        </div>
        <div class="mode-badge">MODEL CONFIGURATION</div>
    </header>

    <aside class="sidebar-left">
        <div>
            <h3>SYSTEM VITALS</h3>
            <div class="vital-card">
                <div class="vital-chart"><canvas id="cpuChart"></canvas></div>
                <div class="vital-info">
                    <div class="vital-label">CPU LOAD</div>
                    <div class="vital-val" id="val-cpu">...</div>
                </div>
            </div>
            <div class="vital-card">
                <div class="vital-chart"><canvas id="ramChart"></canvas></div>
                <div class="vital-info">
                    <div class="vital-label">RAM USAGE</div>
                    <div class="vital-val" id="val-ram">...</div>
                </div>
            </div>
        </div>
        <div>
            <h3>DATA FEEDS</h3>
            <div class="toggle-row"><span class="toggle-label" style="color:var(--c-info)">HTTP TRAFFIC</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
            <div class="toggle-row"><span class="toggle-label" style="color:var(--c-warn)">SMTP / MAIL</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
            <div class="toggle-row"><span class="toggle-label" style="color:var(--c-crit)">FTP DATA</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
        </div>
    </aside>

    <section class="main-stage">
        <div id="three-container"></div>
        <div class="neural-overlay">
            <div class="neural-stat">FULL ARCHITECTURE VIEW</div>
            <div style="font-size:0.7rem; color:#888; margin-top:5px;">122 &#8594; 122 &#8594; 64 &#8594; 16 &#8594; 64 &#8594; 122 &#8594; 122</div>
        </div>
    </section>

    <aside class="sidebar-right">
        <div>
            <h3>SENSITIVITY THRESHOLD</h3>
            <div class="tuner-box">
                <div class="val-display" id="thresh-val">LOADING...</div>
                <div style="text-align:center; font-size:0.7rem; color:#666;">RECONSTRUCTION ERROR LIMIT</div>
                <input type="range" min="10" max="100" value="25" id="thresh-slider">
            </div>
            <div id="update-msg" class="success-msg">CONFIGURATION UPDATED</div>
        </div>

        <div>
            <h3>PROJECTED PERFORMANCE</h3>
            <div class="chart-wrapper"><canvas id="tuningChart"></canvas></div>
        </div>
        <button onclick="updateThreshold()" class="action-btn" style="padding:15px; background:var(--c-purp); border:none; color:white; font-weight:700; cursor:pointer; width:100%; margin-top:auto;">[ APPLY CONFIGURATION ]</button>
    </aside>
</div>
<script>
const THRESHOLD_API = "/api/settings/threshold";
const LATEST_API = "/api/latest";
const STREAM_URL = "/api/stream/logs";

const threshSlider = document.getElementById('thresh-slider');
const threshVal = document.getElementById('thresh-val');
const updateMsg = document.getElementById('update-msg');

// set slider readable value: convert slider (10-100) to threshold float
function sliderToThreshold(v){ return (v/10000); } // e.g., 25 -> 0.0025
function thresholdToSlider(t){ return Math.round(t * 10000); }

async function loadCurrentThreshold(){
    try {
        const res = await fetch(THRESHOLD_API).then(r=>r.json());
        const val = res.threshold ?? res.value ?? 0.0025;
        if (threshSlider) threshSlider.value = thresholdToSlider(val);
        if (threshVal) threshVal.innerText = (val).toFixed(4);
    } catch(e){ console.warn("Could not load threshold", e); }
}

function updateThresholdUI(v){
    const t = sliderToThreshold(v);
    if (threshVal) threshVal.innerText = t.toFixed(4);
}

async function updateThresholdBackend(){
    const t = sliderToThreshold(threshSlider.value);
    try {
        await fetch(THRESHOLD_API, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({threshold:t})});
        if (updateMsg) { updateMsg.style.display='block'; setTimeout(()=>updateMsg.style.display='none', 1800); }
    } catch(e){ console.warn("Threshold update failed", e); }
}

// wire slider events
if (threshSlider) {
    threshSlider.addEventListener('input', (e)=> updateThresholdUI(e.target.value));
    threshSlider.addEventListener('change', updateThresholdBackend);
}

// SSE preview for neural page
try {
    const sse = new EventSource(STREAM_URL);
    sse.onmessage = (ev) => {
        try {
            const rec = JSON.parse(ev.data);
            // update small preview element if available:
            const preview = document.getElementById('latest-log');
            if (preview) preview.innerText = JSON.stringify(rec, null, 2);
            // update tuner chart etc. (you can plug into existing chart objects)
        } catch(e){ console.warn("Neural SSE parse", e); }
    };
} catch(e){ console.warn("Neural SSE not available", e); }

// init
loadCurrentThreshold();
</script>

</body>
</html>