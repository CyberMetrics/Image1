<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>R.A.D.A.R | COMMAND</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Montserrat:wght@500;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        :root {
            --bg-core: #050505;
            --bg-panel: rgba(12, 12, 12, 0.85); 
            --border-panel: rgba(255, 255, 255, 0.12);
            --text-main: #F5F5F5;
            --text-dim: #888;
            
            --c-safe: #CCFF00;
            --c-info: #00E5FF;
            --c-warn: #FFD600;
            --c-crit: #FF0055;
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg-core); font-family: 'JetBrains Mono'; color: var(--text-main); overflow-y: auto; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #666; border-radius: 3px; } ::-webkit-scrollbar-thumb:hover { background: var(--c-safe); }

        #star-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .bg-grid { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 40px 40px; }

        #app { position: relative; z-index: 10; padding: 20px 40px; max-width: 1800px; margin: 0 auto; }

        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid var(--border-panel); margin-bottom: 30px; position: sticky; top: 0; background: rgba(5,5,5,0.95); z-index: 100; backdrop-filter: blur(10px); }
        .brand { font-family: 'Montserrat'; font-weight: 900; font-size: 1.5rem; color: white; text-decoration: none; letter-spacing: -1px; }
        .brand span { color: var(--c-safe); }

        .controls button { background: transparent; border: 1px solid #333; color: #666; padding: 8px 16px; margin-left: 5px; font-family: 'JetBrains Mono'; font-weight: 700; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .controls button.active { border-color: var(--c-safe); color: var(--c-safe); background: rgba(204,255,0,0.1); }

        .panel { background: var(--bg-panel); border: 1px solid var(--border-panel); border-radius: 4px; padding: 20px; display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .panel h3 { font-family: 'Montserrat'; font-weight: 800; font-size: 0.8rem; color: var(--text-dim); margin: 0 0 15px 0; letter-spacing: 1px; display: flex; justify-content: space-between; text-transform: uppercase; }

        .row-kpi { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; height: 140px; margin-bottom: 20px; }
        .kpi-val { font-family: 'Montserrat'; font-weight: 900; font-size: 2.5rem; line-height: 1; margin-top: auto; }
        .kpi-sub { font-size: 0.65rem; color: var(--text-dim); font-weight: 700; margin-top: 8px; letter-spacing: 1px; }

        .row-main { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; height: 500px; margin-bottom: 20px; }

        .hud-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; position: relative; z-index: 20; }
        .hud-box { background: rgba(0,0,0,0.6); border: 1px solid #333; padding: 10px 15px; font-size: 0.7rem; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; }
        .hud-raw { color: #888; border-left: 3px solid var(--c-info); }
        .hud-pred { color: var(--c-safe); border-left: 3px solid var(--c-safe); font-weight: 700; }

        .row-pies { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; height: 450px; margin-bottom: 20px; }
        .row-deep { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; height: 450px; margin-bottom: 20px; }

        .row-table { display: grid; grid-template-columns: 1fr; min-height: 400px; margin-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        th { text-align: left; padding: 15px; color: var(--c-safe); border-bottom: 1px solid #333; background: rgba(255,255,255,0.05); position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #222; }

        .badge { padding: 3px 8px; border-radius: 2px; font-weight: 700; font-size: 0.65rem; border:1px solid; }
        .b-High { color: var(--c-crit); border-color:var(--c-crit); background: rgba(255,0,85,0.1); }
        .b-Medium { color: var(--c-warn); border-color:var(--c-warn); background: rgba(255,214,0,0.1); }
        .b-Low { color: var(--c-info); border-color:var(--c-info); background: rgba(0,229,255,0.1); }
        .b-Safe { color: var(--c-safe); border-color:var(--c-safe); background: rgba(204,255,0,0.1); }

        /* modal styles used by details view */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #0a0a0a; border: 1px solid var(--c-safe);
            width: 900px; max-width: 96%; padding: 20px;
            box-shadow: 0 0 50px rgba(204, 255, 0, 0.1);
            position: relative; border-radius: 4px;
            max-height: 80vh; overflow: auto;
        }
        .modal-close {
            position: absolute; top: 15px; right: 20px; cursor: pointer;
            color: #666; font-size: 1.5rem;
        }
        .modal-close:hover { color: white; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #222; padding-bottom: 10px; font-size: 0.8rem; }
        .detail-label { color: #666; font-weight: 700; }
        .detail-val { color: var(--text-main); font-family: 'JetBrains Mono'; }
        pre { background: #000; padding: 15px; border: 1px solid #333; color: var(--c-safe); overflow-x: auto; margin-top: 20px; font-size: 0.75rem; border-radius: 4px; }

        /* small table in modal */
        .modal-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 15px; }
        .modal-table th, .modal-table td { padding: 8px; border-bottom: 1px solid #222; text-align: left; }
        
        /* Chart Scrollbar Wrapper */
        .chart-scroll-wrapper { width: 100%; height: 100%; overflow-x: auto; overflow-y: hidden; position: relative; }
        .chart-body { height: 100%; min-width: 100%; position: relative; }
    </style>
</head>
<body>

<canvas id="star-canvas"></canvas>
<div class="bg-grid"></div>

<div id="app">

    <header>
        <a href="/" class="brand">&lt; R.A.D.A.R <span>//</span> INTEL</a>

        <div class="controls">
            <button id="btn-live" class="active" onclick="setMode('buffer')">LIVE STREAM</button>
            <button id="btn-today" onclick="setMode('today')">24 HOURS</button>
            <button id="btn-week" onclick="setMode('week')">7 DAYS</button>
            
            <div style="display:inline-flex; align-items:center; margin-left:15px; gap:5px;">
                <input type="date" id="dateStart" style="background:#000; color:#888; border:1px solid #333; font-family:'JetBrains Mono'; padding:5px;">
                <span style="color:#444">-</span>
                <input type="date" id="dateEnd" style="background:#000; color:#888; border:1px solid #333; font-family:'JetBrains Mono'; padding:5px;">
                <button onclick="applyCustomDate()" style="margin:0; font-size:0.7rem; padding:6px 10px;">APPLY</button>
            </div>

            <div class="toggle-group" style="margin-left: 20px; display:inline-flex; border:1px solid #333;">
                <button id="view-public" class="active" onclick="setView('public')" style="margin:0; border:none; border-right:1px solid #333;">PUBLIC</button>
                <button id="view-private" onclick="setView('private')" style="margin:0; border:none;">PRIVATE</button>
            </div>

            <label style="margin-left:15px; font-size:0.7rem; cursor:pointer; color:#888;">
                <input type="checkbox" id="sampleToggle" checked> LIMIT DATA (200)
            </label>
        </div>
    </header>

    <!-- KPI ROW -->
    <div class="row-kpi">
        <div class="panel"><h3>LIFETIME EVENTS</h3><div class="kpi-val" id="val-db-total">0</div><div class="kpi-sub">TOTAL DB RECORDS</div></div>
        <div class="panel"><h3>EVENTS IN VIEW</h3><div class="kpi-val" id="val-view-total">0</div><div class="kpi-sub">CURRENT SELECTION</div></div>
        <div class="panel"><h3>MAX RISK SCORE</h3><div class="kpi-val" id="val-score">0.00</div><div class="kpi-sub">PEAK MSE</div></div>
        <div class="panel"><h3>ANOMALIES</h3><div class="kpi-val" id="val-anom">0</div><div class="kpi-sub">IN CURRENT VIEW</div></div>
        <div class="panel"><h3>INTEGRITY</h3><div class="kpi-val" id="val-health">100%</div><div class="kpi-sub">HEALTH SCORE</div></div>
    </div>

    <!-- MAIN ROW -->
    <div class="row-main">
        <div class="panel">
            <h3>LIVE SIGNAL INTELLIGENCE</h3>

            <div class="hud-container">
                <div class="hud-box hud-raw" id="hud-raw">RAW_STREAM: --</div>
                <div class="hud-box hud-pred" id="hud-pred">
                    <span>ID: --</span>
                    <span>ASSET: --</span>
                    <span>MSE: 0.0000</span>
                </div>
            </div>

            <div style="flex:1; position:relative; overflow:hidden;">
                <div class="chart-scroll-wrapper" id="mainChartWrapper">
                    <div class="chart-body" id="mainChartBody">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>THREAT SEVERITY</h3>
            <div style="flex:1;"><canvas id="pieMain"></canvas></div>
        </div>
    </div>

    <!-- PIE ROW -->
    <div class="row-pies">
        <div class="panel"><h3>HIGH SEVERITY ASSETS</h3><canvas id="pieHigh"></canvas></div>
        <div class="panel"><h3>MEDIUM SEVERITY ASSETS</h3><canvas id="pieMed"></canvas></div>
        <div class="panel"><h3>LOW SEVERITY ASSETS</h3><canvas id="pieLow"></canvas></div>
    </div>

    <!-- SCATTER + RADAR -->
    <div class="row-deep">
        <div class="panel"><h3>MULTI-DIMENSIONAL CLUSTER</h3><div id="scatter3d" style="width:100%; height:100%;"></div></div>
        <div class="panel"><h3>ATTACK SURFACE [ RADAR ]</h3><canvas id="radarChart"></canvas></div>
    </div>

    <!-- RAW TABLE -->
    <div class="row-table">
        <div class="panel">
            <h3>RAW TELEMETRY <span>[ LATEST 15 ]</span></h3>
            <div style="overflow:auto">
                <table id="rawTable">
            <thead>
                <tr>
                    <th>TIME</th><th>ID</th><th>ASSET</th><th>PROTO</th><th>SVC</th><th>SCORE</th><th>STATUS</th>
                </tr>
            </thead>
            <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

</div> <!-- /app -->

<!-- SLICE MODAL (summary + table) -->
<div id="sliceModal" class="modal-overlay" onclick="closeSliceModal(event)">
    <div class="modal-content">
        <span class="modal-close" onclick="closeSliceModal({target:this})">×</span>
        <h2 id="sliceTitle" style="font-family:'Montserrat'; color:white; margin-top:0; margin-bottom:10px;">CATEGORY</h2>
        <div id="sliceSummary" style="color:#ddd; margin-bottom:10px;"></div>
        <div style="overflow:auto; max-height:50vh;">
            <table class="modal-table" id="sliceTable">
                <thead><tr><th>TIME</th><th>ID</th><th>ASSET</th><th>SCORE</th><th>STATUS</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- DETAIL MODAL -->
<div id="detailModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal({target:this})">×</span>
        <h2 style="font-family:'Montserrat'; color:white; margin-top:0; margin-bottom:20px;">EVENT FORENSICS</h2>
        <div id="modalBody"></div>
    </div>
</div>

<!-- ===================== SCRIPTS (charts + SSE + UI) ===================== -->
<script>
/* Globals and configuration */
const STREAM_URL_BASE = "/api/stream/logs";
const STATS_URL = "/api/stats";
const LATEST_URL = "/api/latest";
const ANOMALIES_URL = "/api/anomalies";

let MODE = 'buffer';
let VIEW_MODE = 'public'; // public | private
let LIMIT_SAMPLE = true;
let eventSource = null;
let currentChartData = [];

function setView(view) {
    if (VIEW_MODE === view) return;
    VIEW_MODE = view;
    
    // UI update
    document.getElementById('view-public').classList.toggle('active', view === 'public');
    document.getElementById('view-private').classList.toggle('active', view === 'private');
    
    // Reset data
    currentChartData = [];
    document.querySelector('#rawTable tbody').innerHTML = '';
    
    // Restart stream and fetch
    if (eventSource) eventSource.close();
    startStream();
    fetchInitial();
}
const MAX_POINTS = 50;

/* Utility: safe parse */
function safeParse(s){ try { return JSON.parse(s); } catch(e) { return {}; } }

/* Normalize inbound record */
function normalizeRecord(r){
    if (!r || typeof r !== 'object') r = {};
    const score = (r.score !== undefined) ? Number(r.score) : (r.anomaly_score !== undefined ? Number(r.anomaly_score) : 0);
    const sev = r.severity || (score >= 0.05 ? 'High' : score >= 0.02 ? 'Medium' : score >= 0.01 ? 'Low' : 'Safe');
    return {
        id: r.id || (r._id ? String(r._id) : ""),
        timestamp: r.timestamp || r.created_at || new Date().toISOString(),
        asset_id: r.asset_id || r.hostname || "UNKNOWN",
        protocol: r.protocol || (r.raw_data ? (safeParse(r.raw_data).protocol || safeParse(r.raw_data).proto || "SYS") : "SYS"),
        service: r.service || r.source || "Unknown",
        score: isNaN(score) ? 0 : score,
        severity: sev,
        raw_data: r.raw_data || r.message || "",
        is_anomaly: r.is_anomaly !== undefined ? r.is_anomaly : (score >= 0.05)
    };
}

/* Charts container */
window.charts = {
    main: null,
    pieMain: null,
    pieHigh: null,
    pieMed: null,
    pieLow: null,
    radar: null
};

/* Chart click handler - opens modal with selected event */
function chartClickHandler(evt, elements) {
    if (!elements || elements.length === 0) return;
    const index = elements[0].index;
    const ch = window.charts.main;
    if (!ch) return;
    // Map index to record in currentChartData — chart and buffer are kept aligned
    const record = currentChartData[index] || currentChartData[currentChartData.length - 1];
    if (!record) return;
    openDetailModal(record);
}

/* Open detail modal */
function openDetailModal(r) {
    const modal = document.getElementById("detailModal");
    const body = document.getElementById("modalBody");
    body.innerHTML = `
        <div class="detail-row"><span class="detail-label">ID</span><span class="detail-val">${r.id}</span></div>
        <div class="detail-row"><span class="detail-label">Timestamp</span><span class="detail-val">${r.timestamp}</span></div>
        <div class="detail-row"><span class="detail-label">Asset</span><span class="detail-val">${r.asset_id}</span></div>
        <div class="detail-row"><span class="detail-label">Protocol</span><span class="detail-val">${r.protocol}</span></div>
        <div class="detail-row"><span class="detail-label">Service</span><span class="detail-val">${r.service}</span></div>
        <div class="detail-row"><span class="detail-label">Source</span><span class="detail-val">${VIEW_MODE.toUpperCase()}</span></div>
        <div class="detail-row"><span class="detail-label">Severity</span><span class="detail-val">${r.severity}</span></div>
        <div class="detail-row"><span class="detail-label">Score</span><span class="detail-val">${(r.score).toFixed(6)}</span></div>
        <pre>${(r.raw_data||"").replace(/</g,"&lt;").slice(0,20000)}</pre>
    `;
    modal.style.display = "flex";
}

/* Close modal */
function closeModal(e){
    const overlay = document.getElementById('detailModal');
    if (!overlay) return;
    if (e && (e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close'))) {
        overlay.style.display = "none";
    } else if (!e) overlay.style.display = "none";
}

/* Close slice modal */
function closeSliceModal(e){
    const overlay = document.getElementById('sliceModal');
    if (!overlay) return;
    if (e && (e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close'))) {
        overlay.style.display = "none";
    } else if (!e) overlay.style.display = "none";
}

/* Initialize charts (runs after DOM ready) */
function initMainChart() {
    const ctx = document.getElementById("mainChart");
    if (!ctx) return;
    window.charts.main = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: [{
                label: "Anomaly Score",
                data: [],
                borderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 7,
                borderColor: "#00E5FF",
                backgroundColor: "rgba(0,229,255,0.06)",
                tension: 0.3
            }]
        },
        options: {
            animation: false,
            responsive: true,
            scales: {
                x: { ticks: { color: "#777" }, grid: { color: "#222" } },
                y: { ticks: { color: "#777" }, grid: { color: "#222" } }
            },
            plugins: { 
                legend: { labels: { color: "white" } }
            },
            onClick: function(evt, elements){ chartClickHandler(evt, elements); },
            maintainAspectRatio: false
        }
    });
}

function initPieCharts() {
    // main full distribution pie
    const labelsFull = ["High","Medium","Low","Safe"];
    const colors = ["#FF0055","#FFD600","#00E5FF","#CCFF00"];

    const mainCtx = document.getElementById("pieMain");
    if (mainCtx) {
        window.charts.pieMain = new Chart(mainCtx, {
            type: "doughnut",
            data: { labels: labelsFull, datasets: [{ data: [0,0,0,0], backgroundColor: colors }] },
            options: { plugins: { legend: { labels: { color: "white" } } }, cutout: '55%', maintainAspectRatio:false }
        });
    }

    // small pies: category vs Other
    const highCtx = document.getElementById("pieHigh");
    if (highCtx) {
        window.charts.pieHigh = new Chart(highCtx, {
            type: "doughnut",
            data: { labels: ["High","Other"], datasets: [{ data: [0,1], backgroundColor: ["#FF0055","#222"] }] },
            options: { plugins: { legend: { labels: { color: "white" } } }, cutout:'70%', maintainAspectRatio:false }
        });
        highCtx.onclick = (evt) => onSmallPieClick(evt, window.charts.pieHigh, 'High');
    }

    const medCtx = document.getElementById("pieMed");
    if (medCtx) {
        window.charts.pieMed = new Chart(medCtx, {
            type: "doughnut",
            data: { labels: ["Medium","Other"], datasets: [{ data: [0,1], backgroundColor: ["#FFD600","#222"] }] },
            options: { plugins: { legend: { labels: { color: "white" } } }, cutout:'70%', maintainAspectRatio:false }
        });
        medCtx.onclick = (evt) => onSmallPieClick(evt, window.charts.pieMed, 'Medium');
    }

    const lowCtx = document.getElementById("pieLow");
    if (lowCtx) {
        window.charts.pieLow = new Chart(lowCtx, {
            type: "doughnut",
            data: { labels: ["Low","Other"], datasets: [{ data: [0,1], backgroundColor: ["#00E5FF","#222"] }] },
            options: { plugins: { legend: { labels: { color: "white" } } }, cutout:'70%', maintainAspectRatio:false }
        });
        lowCtx.onclick = (evt) => onSmallPieClick(evt, window.charts.pieLow, 'Low');
    }
}

function initRadarChart() {
    const r = document.getElementById("radarChart");
    if (!r) return;
    window.charts.radar = new Chart(r, {
        type: "radar",
        data: { labels: ["CPU","Network","Disk","Auth","Syscalls","Memory"], datasets:[{ label:"Risk Surface", data:[0,0,0,0,0,0], borderColor:"#CCFF00", backgroundColor:"rgba(204,255,0,0.2)" }] },
        options: { scales: { r: { grid: { color:"#333" }, pointLabels:{ color:"white" }, ticks:{ display:false } } }, plugins:{ legend:{ display:false } }, maintainAspectRatio:false }
    });
}

function initScatter3D() {
    const el = document.getElementById("scatter3d");
    if (!el || typeof Plotly === 'undefined') return;
    Plotly.newPlot(el, [{ x:[0], y:[0], z:[0], mode:"markers", type:"scatter3d", marker:{ size:4, color:"#00E5FF" } }], { margin:{l:0,r:0,b:0,t:0}, paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)", scene:{ xaxis:{showgrid:true}, yaxis:{showgrid:true}, zaxis:{showgrid:true} } });
}

/* Null-safe KPI updater */
function updateKPIs(stats = {}, latestRec = null){
    try {
        if (!stats || typeof stats !== "object") stats = {};
        // only update if we have a valid stat value
        const totalLogs = stats.total_logs ?? stats.db_total ?? stats.count;

        const dbTotalEl = document.getElementById('val-db-total');
        if (dbTotalEl && totalLogs !== undefined) dbTotalEl.innerText = totalLogs;

        const viewTotalEl = document.getElementById('val-view-total');
        if (viewTotalEl) viewTotalEl.innerText = currentChartData.length;

        const scoreEl = document.getElementById('val-score');
        if (scoreEl) {
            const score = latestRec ? (latestRec.score ?? latestRec.anomaly_score ?? 0) : (scoreEl.innerText || 0);
            scoreEl.innerText = Number(score).toFixed(4);
        }

        const anomEl = document.getElementById('val-anom');
        if (anomEl) anomEl.innerText = currentChartData.filter(x => x.is_anomaly).length;

        const healthEl = document.getElementById('val-health');
        if (healthEl) {
            const avg = currentChartData.length ? currentChartData.reduce((s, x) => s + x.score, 0) / currentChartData.length : 0;
            const health = Math.max(20, Math.round(Math.max(0, (1 - avg / 0.1)) * 100));
            healthEl.innerText = `${health}%`;
        }
    } catch(e) {
        console.warn("updateKPIs err", e);
    }
}

/* Helper: compute summary for a filtered slice */
function computeSummaryFor(records) {
    const count = records.length;
    if (!count) return {count:0, min:0, max:0, avg:0};
    const vals = records.map(r => r.score);
    const min = Math.min(...vals);
    const max = Math.max(...vals);
    const avg = vals.reduce((s,v)=>s+v,0)/vals.length;
    return { count, min, max, avg };
}

/* Open slice modal (summary + table)
   severityLabel: 'High'|'Medium'|'Low' or 'Other' (for others we pass category and mode)
   category: when mode='Other' provide category to invert.
*/
function openSliceModalFor(category, mode='Equal') {
    // mode: 'Equal' -> show only category
    // mode: 'Other' -> show all records NOT category
    const overlay = document.getElementById('sliceModal');
    const title = document.getElementById('sliceTitle');
    const summary = document.getElementById('sliceSummary');
    const tbody = document.querySelector('#sliceTable tbody');

    let filtered;
    if (mode === 'Equal') filtered = currentChartData.filter(r => r.severity === category);
    else filtered = currentChartData.filter(r => r.severity !== category);

    const stats = computeSummaryFor(filtered);
    title.innerText = mode === 'Equal' ? `${category.toUpperCase()} SEVERITY EVENTS` : `NOT ${category.toUpperCase()} EVENTS`;
    summary.innerHTML = `
        <div style="display:flex; gap:20px; margin-bottom:8px;">
            <div><strong>Total:</strong> ${stats.count}</div>
            <div><strong>Peak Score:</strong> ${stats.max.toFixed(6)}</div>
            <div><strong>Avg Score:</strong> ${stats.avg.toFixed(6)}</div>
            <div><strong>Min Score:</strong> ${stats.min.toFixed(6)}</div>
        </div>
    `;

    // build table
    tbody.innerHTML = "";
    filtered.slice(0, 500).forEach((r, idx) => {
        const tr = document.createElement('tr');
        const ttime = (r.timestamp || "").split('T')[1] || r.timestamp || "-";
        tr.innerHTML = `<td style="color:#666">${ttime}</td>
                        <td>${r.id}</td>
                        <td style="color:#00E5FF">${r.asset_id}</td>
                        <td>${r.score.toFixed(6)}</td>
                        <td><span class="badge b-${r.severity}">${r.severity}</span></td>`;
        tr.style.cursor = "pointer";
        tr.onclick = () => openDetailModal(r);
        tbody.appendChild(tr);
    });

    overlay.style.display = "flex";
}

/* Small pie click handler (category-specific)
   chartObj: Chart instance
   category: 'High'|'Medium'|'Low'
*/
function onSmallPieClick(evt, chartObj, category) {
    if (!chartObj) return;
    const points = chartObj.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
    if (!points || !points.length) return;
    const idx = points[0].index;
    // idx 0 -> category slice, idx 1 -> other slice
    if (idx === 0) {
        openSliceModalFor(category, 'Equal');
    } else {
        openSliceModalFor(category, 'Other');
    }
}

/* Process a single normalized record: update charts, table, HUD, KPIs */
function processRecord(raw) {
    const r = normalizeRecord(raw);

    // push into buffer
    if (currentChartData.some(x => x.id === r.id)) return;
    currentChartData.push(r);

    // --- MAIN LINE CHART ---
    try {
        const ch = window.charts.main;
        if (ch) {
            const label = (r.timestamp || "").split('T')[1] || new Date().toLocaleTimeString();
            ch.data.labels.push(label);
            ch.data.datasets[0].data.push(r.score);

            // Dynamic Width Logic for Scrollbar
            const wrapper = document.getElementById('mainChartWrapper');
            const body = document.getElementById('mainChartBody');
            if (wrapper && body) {
                const totalPoints = ch.data.labels.length;
                // User wants "only 10 logs clearly". 
                // If container is ~800px, 10 items => 80px per item.
                const pointWidth = 80; 
                const neededWidth = totalPoints * pointWidth;
                
                // Expand the chart body width beyond container to force scroll
                body.style.width = Math.max(wrapper.clientWidth, neededWidth) + "px";
                
                // Auto-scroll to end ONLY if user is already near the end (Sticky Scroll)
                // This prevents "fighting" the user if they scroll back to inspect history
                if (MODE === 'buffer') {
                    const isAtEnd = (wrapper.scrollWidth - wrapper.scrollLeft) <= (wrapper.clientWidth + 150);
                    if (isAtEnd) {
                        requestAnimationFrame(() => {
                            wrapper.scrollLeft = wrapper.scrollWidth;
                        });
                    }
                }
            }

            ch.update('none');
        } else {
            if (currentChartData.length > MAX_POINTS) currentChartData.shift();
        }
    } catch(e){ console.warn("main chart update error", e); }

    // --- PIE UPDATES ---
    try {
        const counts = { High:0, Medium:0, Low:0, Safe:0 };
        currentChartData.forEach(x => counts[x.severity] = (counts[x.severity]||0) + 1);
        const total = Math.max(1, currentChartData.length);

        // full distribution
        if (window.charts.pieMain) {
            window.charts.pieMain.data.datasets[0].data = [counts.High, counts.Medium, counts.Low, counts.Safe];
            window.charts.pieMain.update('none');
        }

        // small pies: category vs Other (Other = total - category)
        if (window.charts.pieHigh) {
            window.charts.pieHigh.data.datasets[0].data = [counts.High, total - counts.High];
            window.charts.pieHigh.update('none');
        }
        if (window.charts.pieMed) {
            window.charts.pieMed.data.datasets[0].data = [counts.Medium, total - counts.Medium];
            window.charts.pieMed.update('none');
        }
        if (window.charts.pieLow) {
            window.charts.pieLow.data.datasets[0].data = [counts.Low, total - counts.Low];
            window.charts.pieLow.update('none');
        }
    } catch(e){ console.warn("pie update err", e); }

    // --- RADAR ---
    try {
        if (window.charts.radar) {
            const counts = { High:0, Medium:0, Low:0, Safe:0 };
            currentChartData.forEach(x => counts[x.severity] = (counts[x.severity]||0) + 1);
            const total = Math.max(1, currentChartData.length);
            const radarVals = [
                (counts.High/total)*100,
                (counts.Medium/total)*80,
                (counts.Low/total)*60,
                (counts.High/total)*90,
                (counts.Medium/total)*70,
                (counts.Safe/total)*50
            ];
            window.charts.radar.data.datasets[0].data = radarVals;
            window.charts.radar.update('none');
        }
    } catch(e){ console.warn("radar err", e); }

    // --- SCATTER 3D ---
    try {
        const el = document.getElementById('scatter3d');
        if (el && typeof Plotly !== 'undefined') {
            const t = new Date(r.timestamp || Date.now()).getTime() / 1000;
            const y = Math.min(1, r.score / 0.1) * 100;
            const hash = (String(r.asset_id).split('').reduce((s,c)=>s + c.charCodeAt(0),0) % 100) - 50;
            Plotly.extendTraces(el, { x:[[t]], y:[[y]], z:[[hash]] }, [0]);
        }
    } catch(e){ console.warn("scatter err", e); }

    // --- HUD ---
    try {
        const hudRaw = document.getElementById('hud-raw');
        const hudPred = document.getElementById('hud-pred');
        if (hudRaw) hudRaw.innerText = (r.raw_data && r.raw_data.length>120) ? r.raw_data.slice(0,120) + "…" : r.raw_data || '--';
        if (hudPred) hudPred.innerHTML = `ID: ${r.id || '--'} &nbsp;&nbsp; ASSET: ${r.asset_id} &nbsp;&nbsp; MSE: ${(r.score).toFixed(4)}`;
    } catch(e){}

    // --- TABLE ---
    try {
        const tbody = document.querySelector('#rawTable tbody');
        if (tbody) {
            const tr = document.createElement('tr');
            const ttime = (r.timestamp || "").split('T')[1] || r.timestamp || "-";
            tr.innerHTML = `<td style="color:#666">${ttime}</td>
                            <td>${r.id}</td>
                            <td style="color:#00E5FF">${r.asset_id}</td>
                            <td>${r.protocol}</td>
                            <td>${r.service}</td>
                            <td>${(r.score).toFixed(4)}</td>
                            <td><span class="badge b-${r.severity}">${r.severity}</span></td>`;
            tbody.insertBefore(tr, tbody.firstChild);
            while (tbody.rows.length > 15) tbody.deleteRow(-1);
        }
    } catch(e){ console.warn("table err", e); }

    // KPIs
    updateKPIs(null, r);
}

/* Initial fetch of stats + latest */
async function fetchInitial(){
    try {
        const [sResp, lResp] = await Promise.all([
            fetch(STATS_URL + "?view=" + VIEW_MODE).then(r=>r.json()).catch(()=>({})),
            fetch(LATEST_URL + "?view=" + VIEW_MODE).then(r=>r.json()).catch(()=>({}))
        ]);
        const stats = sResp || {};
        const latest = (lResp && (lResp.data || lResp)) || null;
        if (latest) processRecord(normalizeRecord(latest));
        updateKPIs(stats, latest);
    } catch(e){ console.warn("fetchInitial err", e); }
}

/* Start SSE stream */
function startStream(){
    try {
        if (eventSource) eventSource.close();
        eventSource = new EventSource(STREAM_URL_BASE + "?view=" + VIEW_MODE);
        eventSource.onopen = () => console.log("SSE connected (" + VIEW_MODE + ")");
        eventSource.onerror = (err) => { console.warn("SSE err", err); };
        eventSource.onmessage = (e) => {
            try {
                const payload = safeParse(e.data);
                processRecord(payload);
            } catch(err) { console.warn("SSE parse", err); }
        };
    } catch(e) {
        console.warn("SSE start failed", e);
    }
}

/* Poll fallback for servers that don't support SSE */
async function pollFallback() {
    try {
        const res = await fetch(ANOMALIES_URL + "?page=1&sample=15&view=" + VIEW_MODE).then(r=>r.json()).catch(()=>null);
        if (!res) return;
        const rows = res.anomalies || (res.data ? (Array.isArray(res.data) ? res.data : [res.data]) : null);
        if (rows) rows.slice(0, LIMIT_SAMPLE ? 200 : rows.length).forEach(x => processRecord(normalizeRecord(x)));
    } catch(e) { /* ignore */ }
}

/* Mode switching and controls */
function setMode(m) {
    MODE = m;
    document.getElementById('btn-live')?.classList.remove('active');
    document.getElementById('btn-today')?.classList.remove('active');
    document.getElementById('btn-week')?.classList.remove('active');
    
    if (m === 'buffer') document.getElementById('btn-live')?.classList.add('active');
    if (m === 'today') document.getElementById('btn-today')?.classList.add('active');
    if (m === 'week') document.getElementById('btn-week')?.classList.add('active');

    if (m === 'buffer') {
        startStream();
        return;
    } else {
        if(eventSource) eventSource.close();
    }

    currentChartData = [];
    document.querySelector('#rawTable tbody').innerHTML = '';

    // Clear main chart visuals
    if (window.charts && window.charts.main) {
        window.charts.main.data.labels = [];
        window.charts.main.data.datasets[0].data = [];
        window.charts.main.update();
    }

    // Fetch logic
    (async ()=>{
        try {
            let url = ANOMALIES_URL + `?view=${VIEW_MODE}&per_page=200`;
            
            if (m === 'today') {
                url += "&range=day";
            } else if (m === 'week') {
                url += "&range=week";
            }

            const res = await fetch(url).then(r=>r.json()).catch(()=>null);
            const rows = res?.anomalies || (res?.data ? (Array.isArray(res.data) ? res.data : [res.data]) : null);
            
            if (rows && rows.length > 0) {
                 rows.forEach(r => processRecord(normalizeRecord(r)));
                 // Auto-scroll to end (latest)
                 setTimeout(() => {
                     const wrapper = document.getElementById('mainChartWrapper');
                     if(wrapper) wrapper.scrollLeft = wrapper.scrollWidth;
                 }, 300);
            } else {
                 console.log("No data found for mode", m);
            }
        } catch(e){ console.warn("fetch mode err", e); }
    })();
}

/* Custom Date Range */
function applyCustomDate() {
    const s = document.getElementById('dateStart').value;
    const e = document.getElementById('dateEnd').value;
    if (!s || !e) return alert("Select start and end dates");

    setMode('custom'); // clear buttons, stop stream if running

    // Clear explicitly again as setMode('custom') does it too
    
    // Convert to ISO (approx)
    const tStart = new Date(s).toISOString();
    const tEnd = new Date(e + "T23:59:59").toISOString();

    (async () => {
        try {
            const url = ANOMALIES_URL + `?start=${tStart}&end=${tEnd}&per_page=500&view=${VIEW_MODE}`;
            const res = await fetch(url).then(r => r.json()).catch(() => null);
            const rows = res?.anomalies || (res?.data ? (Array.isArray(res.data) ? res.data : [res.data]) : null);
            if (rows && rows.length) {
                rows.forEach(r => processRecord(normalizeRecord(r)));
                setTimeout(() => {
                     const wrapper = document.getElementById('mainChartWrapper');
                     if(wrapper) wrapper.scrollLeft = wrapper.scrollWidth;
                }, 300);
            } else {
                alert("No logs found in this range.");
            }
        } catch (err) { console.warn("custom date err", err); }
    })();
}

/* Wire sample toggle */
document.addEventListener("DOMContentLoaded", function(){
    const samp = document.getElementById('sampleToggle');
    if (samp) {
        LIMIT_SAMPLE = samp.checked;
        samp.addEventListener('change', (e)=> { LIMIT_SAMPLE = e.target.checked; });
    }
});

/* Initialize everything on DOM ready */
document.addEventListener("DOMContentLoaded", function(){
    initMainChart();
    initPieCharts();
    initRadarChart();
    initScatter3D();

    // initial data + stream
    fetchInitial();
    setMode('buffer');
});
</script>

</body>
</html>